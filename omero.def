BootStrap: debootstrap
OSVersion: trusty
MirrorURL: http://us.archive.ubuntu.com/ubuntu/

%post
  echo "Installing build tools"
  sed 's/main$/main universe/' -i /etc/apt/sources.list
  apt-get update
  apt-get install -y --no-install-recommends \
    software-properties-common gcc g++ wget less

  echo "Installing OMERO dependencies"
  add-apt-repository -y ppa:openjdk-r/ppa
  add-apt-repository -y ppa:fkrull/deadsnakes-python2.7
  apt-get update
  apt-get install -y --no-install-recommends \
    openjdk-7-jre \
    python python-dev \
    python-pip \
    python-virtualenv \
    python-matplotlib python-scipy python-tables \
    libtiff5-dev libjpeg8-dev zlib1g-dev libfreetype6-dev liblcms2-dev \
    libwebp-dev tcl8.6-dev tk8.6-dev
  pip install --upgrade pip
  /usr/local/bin/pip install "Pillow==2.9.0"

  echo "Installing Ice 3.6"
  apt-key adv --keyserver keyserver.ubuntu.com --recv 5E6DA83306132997
  apt-add-repository "deb http://zeroc.com/download/apt/ubuntu`lsb_release -rs` stable main"
  apt-get update
  apt-get install -y --no-install-recommends \
    db5.3-util libssl-dev libbz2-dev libmcpp-dev libdb++-dev libdb-dev \
    zeroc-ice-all-runtime zeroc-ice-all-dev
  /usr/local/bin/pip install "zeroc-ice==3.6.3"

  echo "Installing Postgres"
  add-apt-repository -y "deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main"
  wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
  apt-get update
  apt-get install -y --no-install-recommends postgresql-9.4
  locale-gen en_US.utf8
  chmod -R o+rw /var/run/postgresql
  service postgresql stop

  echo "Installing OMERO.web dependencies"
  add-apt-repository -y ppa:nginx/stable
  apt-get update
  apt-get install -y --no-install-recommends \
    nginx openssl
  /usr/local/bin/pip install \
    "django==1.8.16" \
    "django-debug-toolbar==1.6" \
    "gunicorn==19.6.0"
  rm /etc/nginx/sites-enabled/default
  chmod -R o+w /etc/nginx
  chmod -R go+rw /var/log/nginx

  echo "Installing supervisor"
  /usr/local/bin/pip install "supervisor==3.3.1"

  echo "Installing OMERO"
  export OMERO_DIR=/omero
  export OMERO_HOME=$OMERO_DIR/OMERO.server
  /usr/local/bin/pip install "omego==0.4.1"
  mkdir $OMERO_DIR
  cd $OMERO_DIR
  omego download --branch=5.2.6 --ice 3.6 --unzipdir . -v server
  rm OMERO.server*zip
  ln -s OMERO.server-* $OMERO_HOME
  chmod -R o+rw $OMERO_HOME

  echo "Creating bind points"
  mkdir $OMERO_DIR/run
  mkdir $OMERO_DIR/data
  mkdir $OMERO_DIR/var
  mkdir $OMERO_DIR/user_scripts
  mkdir $OMERO_DIR/postgres
  rm -r $OMERO_HOME/var
  ln -s $OMERO_DIR/var $OMERO_HOME/var
  ln -s $OMERO_DIR/user_scripts $OMERO_HOME/lib/scripts/custom_scripts

  echo "Configuring environment"
  echo >> /environment
  echo 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> /environment
  echo 'export PATH=/omero/OMERO.server/bin:/usr/lib/postgresql/9.4/bin:$PATH' >> /environment
  echo >> /environment
  echo 'unset TZ' >> /environment

%runscript
  trap "/omero/run/shutdown.sh; exit" SIGHUP SIGINT SIGTERM
  supervisord --nodaemon -c /omero/run/supervisor.conf
